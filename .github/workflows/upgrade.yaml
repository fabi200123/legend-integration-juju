name: Upgrade Juju Controller and Juju Model

on:
  workflow_dispatch:
    inputs:
      agent_version:
        description: 'Upgrade to version'
        required: true
        default: '3.1.0'

jobs:
  build:
    name: Trigger Juju ugrade controller and model on EKS Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Installing Dependencies
        run: |
          sudo snap install juju --channel=3.1/stable --classic
      - name: Install Docker
        uses: docker-practice/actions-setup-docker@master

      # We need the kubeconfig and the controllers.yaml file into our environment
      # in order to login and refresh the charms.
      - name: Adding Credentials
        shell: bash
        run: |
          mkdir -p ~/.kube
          mkdir -p ~/.local/share/juju
          echo "${KUBECONFIG_B64}" | base64 -d > ~/.kube/config
          echo "${CONTROLLERS_B64}" | base64 -d > ~/.local/share/juju/controllers.yaml
          # echo "${CONTROLLER_PASSWORD}" | juju login -c finos-legend-v3 -u admin
        env:
          KUBECONFIG_B64: "${{ secrets.KUBECONFIG_B64 }}"
          CONTROLLERS_B64: "${{ secrets.CONTROLLERS_B64 }}"
          CONTROLLER_PASSWORD: "${{ secrets.CONTROLLER_PASSWORD }}"

      - if: ${{ github.event.inputs.agent_version }} > "juju version | cut -d- -f1"
        name: Upgrade Juju Controller and Juju Model
        run: |
        # Upgrading the controller
        juju upgrade-controller -c finos-legend-v3 --agent-version ${{ github.event.inputs.agent_version }}
        
        # Upgrading the model finos-legend
        juju upgrade-model -m finos-legend --agent-version ${{ github.event.inputs.agent_version }}

        # Upgrading the model finos-legend-twin
        juju upgrade-model -m finos-legend-twin --agent-version ${{ github.event.inputs.agent_version }}
        env:
          AGENT_VERSION: "${{ secrets.AGENT_VERSION }}"
